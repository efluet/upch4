{
    "collab_server" : "",
    "contents" : "#  Extend  timeseries, make a lineplot of global Teragrams per month\n#  use all 35 models & plot the median value at each pixel (or random subset of models)\n#  make clean gifs of flux and emission\n\n\n# Ask sarah & bn for the model \n#    time series vs LSM\n#    make a map of the spatial differences\n\n\n\n\nlibrary(caret)\nlibrary(ranger)\nlibrary(stats)\nlibrary(raster)\nlibrary(scales)\n\n\n\n# read the raster stacks\nLST_Day_CMG_stack <- readRDS(\"../../data/modis_processed/LST_Day_CMG_stack.rds\")\nLST_Night_CMG_stack <- readRDS(\"../../data/modis_processed/LST_Night_CMG_stack.rds\")\nlat <- readRDS(\"../../data/modis_processed/lat_grid.rds\")\n\n\n\n\n# get Random forest model\nagu_rf_model <- readRDS(\"../../data/random_forest/agu_rf_model.rds\")\n\n\n\n\n#==============================================================================#\n###            Make random forest predictions of flux           ----------------\n#==============================================================================#\n\n# create empty stack\noutput_stack <- stack()\n\n\n# loop through each raster (timestep)\nfor (i in seq(1, length(names(LST_Day_CMG_stack)))){\n  \n  print(i)\n  \n  # stack a temporary predictors\n  temp <-stack(LST_Day_CMG_stack[[i]] + 273,\n               LST_Night_CMG_stack[[i]] + 273,\n               mask(lat, LST_Day_CMG_stack[[i]]))  # masking the lat grid\n\n  # rename columns\n  names(temp) <- c(\"LSTN\",\"LSTD\",\"Latitude\")\n  \n  # predictions are in nanomoles / m^2 / sec\n  z <- raster::predict(temp, agu_rf_model[[1]], progress=\"text\", na.rm=T)\n  # raster::\n  \n  names(z) <- names(LST_Day_CMG_stack[[i]])\n  \n  output_stack <- stack(output_stack, z)\n  }\n\n\n\n\n\n\n#==============================================================================#\n###            Mask flux predictions to wetland area           -----------------\n#==============================================================================#\n\n# read the netcdf\nf <- '../../data/wetmap/gcp-ch4_wetlands_2000-2017_025deg.nc'\n# open netcdf file\nwo <- nc_open(f)\n# read wet fraction as raster brick\nFw <-brick(f, varname=\"Fw\")\n\n\ncrs(output_stack) <- crs(Fw)\n\n# create empty stack\nmasked_flux_stack <- stack()\n\nfor (i in seq(1, length(names(LST_Day_CMG_stack)))) {\n  \n  print(i)\n  \n  # mask fluxes in pixels below a certain wetland area \n  Fw_mask <- Fw[[1+i]]\n  \n  #Fw_mask[Fw_mask < 0.05] <- NA\n  Fw_mask[Fw_mask == 0] <- NA\n  \n  \n  temp_masked <- mask(output_stack[[i]], Fw_mask)\n  \n  names(temp_masked) <- names(output_stack[[i]])\n  \n  # add to stack\n  masked_flux_stack <- stack(masked_flux_stack, temp_masked)\n  }\n\n# conv from nmol to g  of CH4 \n# 1 nanomol ch4  = 16.04246 g ch4   /  1e+9\n\nmasked_flux_stack <- masked_flux_stack / 1e+9 * 16.04246\n\n# conv from sec to month\nmasked_flux_stack <- masked_flux_stack * 2.628e+6\n\nsaveRDS(masked_flux_stack, '../../output/results/upscaled_stack_flux_g_m2_month.rds')\n\n\n#==============================================================================#\n###         Convert flux from nanomol m^2 sec^-1  to Teragrams      ------------\n#==============================================================================#\n\n## TO DO LIST:   Tg CH4 per month\n# 1 nanomol ch4  = 16.04246 g ch4   /  1e+9\n# 1 nanomol ch4  = 1e-21 TeraG\n# 1 m^2  -->  1e-6 km^2\n# 1 sec --> 3.80517e-7 month\n\n\n# calculate area of gridcell\npixarea <- area(output_stack[[1]])\n\nlibrary(ncdf4)\n# read the netcdf\nf <- '../../data/wetmap/gcp-ch4_wetlands_2000-2017_025deg.nc'\n# open netcdf file\nwo <- nc_open(f)\n# read wet fraction as raster brick\nFw <-brick(f, varname=\"Fw\")\nAw <- Fw * pixarea\n\n\n\n\n\nupscaled_stack <- stack()\n\nfor (i in seq(1, length(names(LST_Day_CMG_stack)))){\n\n  print(i)\n  \n  \n  # multiply by area\n  # this is in nanomoles per km2   multiplied by area (km2\n  # result is  total nanomales per second)\n  temp_upscaled <- output_stack[[i]] * 10^6 * Aw[[1+i]]\n  \n  # converting nanomoles/sec  to  Teragrams per sec;  16.04 moles of methane per grams of methane\n  temp_upscaled <- temp_upscaled  * 1e-21 *  16.04246\n\n  # converting teragrams/sec  to  Teragrams per month\n  temp_upscaled <- temp_upscaled  * 2.628e+6\n  \n  names(temp_upscaled) <- names(output_stack[[i]])\n  \n  upscaled_stack <- stack(upscaled_stack, temp_upscaled)\n  \n    \n  }\n\n\nsaveRDS(upscaled_stack, '../../output/results/upscaled_stack_tg_permonth.rds')\n\n\n\n\n\n\n\n\n#==============================================================================#\n###         Convert flux to  g m^2 sec^-1 ; scaled over entire pixel area      ------------\n#==============================================================================#\n\n\n## TO DO LIST:   Tg CH4 per month\n# 1 nanomol ch4  = 16.04246 g ch4   /  1e+9\n# 1 nanomol ch4  = 1e-21 TeraG\n# 1 m^2  -->  1e-6 km^2\n# 1 sec --> 3.80517e-7 month\n\n\n# calculate area of gridcell\npixarea <- area(output_stack[[1]])\n\nlibrary(ncdf4)\n# read the netcdf\nf <- '../../data/wetmap/gcp-ch4_wetlands_2000-2017_025deg.nc'\n# open netcdf file\nwo <- nc_open(f)\n# read wet fraction as raster brick\nFw <-brick(f, varname=\"Fw\")\nAw <- Fw * pixarea\n\n\n\n\n\nupscaled_stack <- stack()\n\nfor (i in seq(1, length(names(LST_Day_CMG_stack)))){\n  \n  print(i)\n  \n  # multiply by wetland area\n  # this is in nanomoles per km2   multiplied by area (m2)\n  # result is  total nanomales per second)\n  temp_upscaled <- output_stack[[i]] * (10^6 * Aw[[1+i]])\n  \n  # converting nanomoles/sec  to grams per sec;  16.04 moles of methane per grams of methane\n  temp_upscaled <- temp_upscaled  * 1e-9 *  16.04246\n  \n  # converting teragrams/sec  to  grams per month\n  temp_upscaled <- temp_upscaled  * 2.628e+6\n  \n  # divide by whole pixel area\n  temp_upscaled <- temp_upscaled / (pixarea * 10^6) \n  \n  names(temp_upscaled) <- names(output_stack[[i]])\n  \n  upscaled_stack <- stack(upscaled_stack, temp_upscaled)\n  \n  \n}\n\n\nsaveRDS(upscaled_stack, '../../output/results/upscaled_stack_mmech4.rds')\n\n\n\n\n\n\n\n\n#==============================================================================#\n### make raster sum function (shorten) -----------------------------------------\n#==============================================================================#\n\n\nsum_raster <- function(raster){sum(cellStats(raster, stat=\"sum\"))}\n\n\nupscaled_stack_tg_month <- readRDS('../../output/results/upscaled_stack_tg_permonth.rds')\n\n\nfor (i in seq(1, length(names(upscaled_stack)))){\n  \n  \n  data.frame(names(upscaled_stack)[i],\n             sum_raster(upscaled_stack_tg_month[[i]])),\n  \n}\n",
    "created" : 1544046843015.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1150496122",
    "id" : "AD55263D",
    "lastKnownWriteTime" : 1544371065,
    "last_content_update" : 1544371065,
    "path" : "C:/Users/efluet/Dropbox/upch4/scripts/ch4_upscaling/./rf_predict_grid.r",
    "project_path" : "./rf_predict_grid.r",
    "properties" : {
        "docOutlineVisible" : "1"
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}